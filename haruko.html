<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>API Explorer</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1e1e1e;
      color: #eee;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
    }
    .container {
      background: #2b2b2b;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.7);
      max-width: 800px;
      width: 100%;
    }
    h1 {
      margin-bottom: 1rem;
      font-size: 1.75rem;
      color: #d0bfff;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 1rem;
      align-items: end;
    }
    form label {
      display: flex;
      flex-direction: column;
      font-weight: 500;
    }
    form input, form select {
      padding: 0.5rem;
      background: #3a3a3a;
      color: #eee;
      border: 1px solid #555;
      border-radius: 4px;
      font-size: 1rem;
    }
    form input[type="file"] {
      padding: 0.25rem;
    }
    .buttons {
      grid-column: 1 / -1;
      display: flex;
      gap: 1rem;
    }
    .buttons button {
      flex: 1;
      padding: 0.75rem;
      background-color: #6a0dad;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
    .buttons button:hover {
      background-color: #4a007a;
    }
    #previewContainer,
    #responseContainer {
      margin-top: 2rem;
    }
    .response-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .response-table th,
    .response-table td {
      border: 1px solid #444;
      padding: 8px;
      text-align: left;
      color: #eee;
    }
    .response-table th {
      background-color: #6a0dad;
      color: #fff;
    }
    .response-table tr:nth-child(even) {
      background: #2f2f2f;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const actionEl = document.getElementById('action');
      const limitEl  = document.getElementById('limit');
      const apiKeyEl = document.getElementById('apiKey');
      const fileEl   = document.getElementById('csvFile');
      const previewBtn = document.getElementById('previewBtn');
      const sendBtn    = document.getElementById('sendBtn');
      const previewContainer  = document.getElementById('previewContainer');
      const responseContainer = document.getElementById('responseContainer');

      let parsedRecords = null;

      const readAndParse = () => {
        const file = fileEl.files[0];
        if (!file) {
          alert('Select a CSV before previewing.');
          return null;
        }
        const text = file._text; // reuse if already read
        return new Promise((resolve, reject) => {
          if (text) {
            resolve(text);
          } else {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(reader.error);
            reader.readAsText(file);
          }
        }).then(txt => {
          // cache raw text so send doesn't re-read
          file._text = txt;
          const lines = txt.split(/\r?\n/).filter(l => l.trim());
          const headers = lines[0].split(/\t|,/).map(h => h.trim());
          const rows = lines.slice(1).filter(l => l);
          const records = rows.map(line => {
            const cols = line.split(/\t|,/).map(c => c.trim());
            const r = headers.reduce((acc,h,i)=>(acc[h]=cols[i],acc),{});
            const [date, hour, minute, second] = r['TIMESTAMP'].split(':');
            const dt = `${date} ${hour}:${minute}:${second}`;
            const millis = new Date(dt).getTime();
            return {
              timestamp: millis,
              venueAccount: r['VENUE ACCOUNT'],
              venueAccountId: r['VENUE ACCOUNT ID'],
              venue: r['VENUE'],
              symbol: r['SYMBOL'],
              quantity: parseFloat(r['QUANTITY']),
              price: parseFloat(r['PRICE']),
              side: r['SIDE'],
              counterpartyType: r['COUNTERPARTY TYPE'],
              instrumentType: r['INSTRUMENT TYPE'],
              additionalDataFields: [
                {objectIdType:'PRIMARY_KEY',category:'Metadata',key:'ENRICHMENT SOURCE',value:r['ENRICHMENT SOURCE']},
                {objectIdType:'PRIMARY_KEY',category:'Metadata',key:'BUNDLE',value:r['BUNDLE']},
                {objectIdType:'PRIMARY_KEY',category:'Metadata',key:'BOOK',value:r['BOOK']},
                {objectIdType:'PRIMARY_KEY',category:'Metadata',key:'PORTFOLIO',value:r['PORTFOLIO']},
                {objectIdType:'PRIMARY_KEY',category:'Metadata',key:'ENTITY',value:r['ENTITY']}
              ]
            };
          });
          return records;
        });
      };

      previewBtn.addEventListener('click', () => {
        previewContainer.textContent = 'Parsing CSV…';
        readAndParse()
          .then(records => {
            parsedRecords = records;
            if (!records || records.length === 0) {
              previewContainer.textContent = 'No rows found';
              return;
            }
            // render preview table
            const table = document.createElement('table');
            table.className = 'response-table';
            const thead = table.createTHead();
            const rowHead = thead.insertRow();
            Object.keys(records[0]).forEach(k => {
              const th = document.createElement('th');
              th.textContent = k;
              rowHead.appendChild(th);
            });
            const tbody = table.createTBody();
            records.forEach(item => {
              const row = tbody.insertRow();
              Object.values(item).forEach(v => {
                const cell = row.insertCell();
                cell.textContent = (v !== null && typeof v === 'object')
                  ? JSON.stringify(v)
                  : v;
              });
            });
            previewContainer.innerHTML = '<h3>CSV Preview</h3>';
            previewContainer.appendChild(table);
          })
          .catch(err => {
            previewContainer.textContent = 'Preview error: ' + err.message;
          });
      });

      sendBtn.addEventListener('click', () => {
        if (!parsedRecords) {
          alert('Please preview the CSV before sending.');
          return;
        }
        const action = actionEl.value;
        const limit  = limitEl.value; 
        const apiKey = apiKeyEl.value.trim();
        if (!apiKey) {
          alert('API Key is required.');
          return;
        }

        const url = `https://uk${limit}.haruko.io:2044/cefi/api/${action}`;
        const payload = { [action]: parsedRecords };

        console.log('Sending to:', url);
        console.log('Payload:', payload);
        responseContainer.textContent = 'Request sent…';

        fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `<${apiKey}>`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        })
        .then(res => {
          if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          return res.json();
        })
        .then(data => {
          // unwrap if needed
          const arr = Array.isArray(data) ? data
                    : Array.isArray(data.trades)   ? data.trades
                    : Array.isArray(data.transfers)? data.transfers
                    : [];

          if (arr.length === 0) {
            responseContainer.textContent = 'No response data';
            return;
          }
          const table = document.createElement('table');
          table.className = 'response-table';
          const thead = table.createTHead();
          const rowHead = thead.insertRow();
          Object.keys(arr[0]).forEach(k => {
            const th = document.createElement('th');
            th.textContent = k;
            rowHead.appendChild(th);
          });
          const tbody = table.createTBody();
          arr.forEach(item => {
            const row = tbody.insertRow();
            Object.values(item).forEach(v => {
              const cell = row.insertCell();
              cell.textContent = (v !== null && typeof v === 'object')
                ? JSON.stringify(v)
                : v;
            });
          });
          responseContainer.innerHTML = '<h3>Server Response</h3>';
          responseContainer.appendChild(table);
        })
        .catch(err => {
          responseContainer.textContent = 'Error: ' + err.message;
        });
      });
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>API Explorer</h1>
    <form id="apiForm" onsubmit="return false;">
      <label>
        Action:
        <select id="action">
          <option value="trades">Upload Trades</option>
          <option value="transfers">Upload Transfers</option>
        </select>
      </label>
      <label>
        BIS / CSCM:
        <select id="limit">
          <option value="8">BIS</option>
          <option value="10" selected>CSCM</option>
        </select>
      </label>
      <label>
        API Key:
        <input type="text" id="apiKey" placeholder="your-api-key-here" required />
      </label>
      <label>
        CSV file:
        <input type="file" id="csvFile" accept=".csv" required />
      </label>
      <div class="buttons">
        <button type="button" id="previewBtn">Preview CSV</button>
        <button type="button" id="sendBtn">Send</button>
      </div>
    </form>

    <div id="previewContainer">No preview yet.</div>
    <div id="responseContainer">No response yet.</div>
  </div>
</body>
</html>
