<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>API Explorer</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1e1e1e;
      color: #eee;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
    }
    .container {
      background: #2b2b2b;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.7);
      max-width: 800px;
      width: 100%;
    }
    h1 {
      margin-bottom: 1rem;
      font-size: 1.75rem;
      color: #d0bfff;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 1rem;
      align-items: end;
    }
    form label {
      display: flex;
      flex-direction: column;
      font-weight: 500;
    }
    form input, form select {
      padding: 0.5rem;
      background: #3a3a3a;
      color: #eee;
      border: 1px solid #555;
      border-radius: 4px;
      font-size: 1rem;
    }
    form input[type="file"] {
      padding: 0.25rem;
    }
    .buttons {
      grid-column: 1 / -1;
      display: flex;
      gap: 1rem;
    }
    .buttons button {
      flex: 1;
      padding: 0.75rem;
      background-color: #6a0dad;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
    .buttons button:hover {
      background-color: #4a007a;
    }
    #previewContainer,
    #responseContainer {
      margin-top: 2rem;
    }
    .table-container {
      overflow-x: auto;
      max-height: 300px;
      margin-top: 1rem;
      border: 1px solid #444;
      border-radius: 4px;
    }
    .response-table {
      width: 100%;
      border-collapse: collapse;
    }
    .response-table th,
    .response-table td {
      border: 1px solid #444;
      padding: 6px;
      text-align: left;
      white-space: pre-wrap;
      word-break: break-word;
      color: #eee;
    }
    .response-table th {
      background-color: #6a0dad;
      color: #fff;
    }
    .response-table tr:nth-child(even) {
      background: #2f2f2f;
    }
    pre {
      background: #272727;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const actionEl = document.getElementById('action');
      const limitEl  = document.getElementById('limit');
      const apiKeyEl = document.getElementById('apiKey');
      const fileEl   = document.getElementById('csvFile');
      const previewBtn = document.getElementById('previewBtn');
      const sendBtn    = document.getElementById('sendBtn');
      const previewContainer  = document.getElementById('previewContainer');
      const responseContainer = document.getElementById('responseContainer');

      let parsedRecords = null;

      function parseCSV() {
        const file = fileEl.files[0];
        if (!file) return Promise.reject(new Error('No CSV selected.'));
        return new Promise((resolve, reject) => {
          if (file._text) return resolve(file._text);
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.onerror = () => reject(r.error);
          r.readAsText(file);
        }).then(txt => {
          file._text = txt; // cache it
          const lines = txt.split(/\r?\n/).filter(l => l.trim());
          const headers = lines[0].split(/\t|,/).map(h => h.trim());
          return lines.slice(1).filter(l => l).map(line => {
            const cols = line.split(/\t|,/).map(c => c.trim());
            const row = headers.reduce((acc,h,i)=>(acc[h]=cols[i],acc),{});
            const [date, hour, minute, second] = row.TIMESTAMP.split(':');
            const dt = `${date} ${hour}:${minute}:${second}`;
            const millis = new Date(dt).getTime();
            return {
              timestamp: millis,
              venueAccount: row['VENUE ACCOUNT'],
              venueAccountId: row['VENUE ACCOUNT ID'],
              venue: row.VENUE,
              symbol: row.SYMBOL,
              quantity: parseFloat(row.QUANTITY),
              price: parseFloat(row.PRICE),
              side: row.SIDE,
              counterpartyType: row['COUNTERPARTY TYPE'],
              instrumentType: row['INSTRUMENT TYPE'],
              additionalDataFields: [
                {objectIdType:'PRIMARY_KEY',category:'Metadata',key:'ENRICHMENT SOURCE',value:row['ENRICHMENT SOURCE']},
                {objectIdType:'PRIMARY_KEY',category:'Metadata',key:'BUNDLE',            value:row.BUNDLE},
                {objectIdType:'PRIMARY_KEY',category:'Metadata',key:'BOOK',              value:row.BOOK},
                {objectIdType:'PRIMARY_KEY',category:'Metadata',key:'PORTFOLIO',         value:row.PORTFOLIO},
                {objectIdType:'PRIMARY_KEY',category:'Metadata',key:'ENTITY',            value:row.ENTITY}
              ]
            };
          });
        });
      }

      function renderTable(records, container, title) {
        container.innerHTML = `<h3>${title}</h3>`;
        if (!Array.isArray(records) || records.length === 0) {
          container.innerHTML += '<p>No rows to display.</p>';
          return;
        }
        const table = document.createElement('table');
        table.className = 'response-table';
        const thead = table.createTHead();
        const headRow = thead.insertRow();
        Object.keys(records[0]).forEach(k => {
          const th = document.createElement('th');
          th.textContent = k;
          headRow.appendChild(th);
        });
        const tbody = table.createTBody();
        records.forEach(rec => {
          const row = tbody.insertRow();
          Object.values(rec).forEach(v => {
            const cell = row.insertCell();
            cell.textContent = (v !== null && typeof v === 'object')
              ? JSON.stringify(v)
              : String(v);
          });
        });
        const wrapper = document.createElement('div');
        wrapper.className = 'table-container';
        wrapper.appendChild(table);
        container.appendChild(wrapper);
      }

      previewBtn.addEventListener('click', () => {
        previewContainer.textContent = 'Parsing CSV…';
        parseCSV()
          .then(recs => {
            parsedRecords = recs;
            renderTable(recs, previewContainer, 'CSV Preview');
          })
          .catch(err => {
            previewContainer.textContent = `Preview error: ${err.message}`;
          });
      });

      sendBtn.addEventListener('click', () => {
        if (!parsedRecords) {
          alert('Please preview the CSV before sending.');
          return;
        }
        const action = actionEl.value;
        const limit  = limitEl.value;
        const apiKey = apiKeyEl.value.trim();
        if (!apiKey) {
          alert('API Key is required.');
          return;
        }
        const url = `https://uk${limit}.haruko.io:2044/cefi/api/${action}`;
        const payload = { [action]: parsedRecords };

        console.log('URL →', url);
        console.log('Payload →', payload);

        responseContainer.textContent = 'Sending request…';
        fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `<${apiKey}>`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        })
        .then(r => {
          if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
          return r.json();
        })
        .then(json => {
          console.log('Response JSON →', json);
          // unwrap if array stems from trades/transfers
          const arr = Array.isArray(json)       ? json
                    : Array.isArray(json.trades)   ? json.trades
                    : Array.isArray(json.transfers)? json.transfers
                    : null;
          if (arr) {
            renderTable(arr, responseContainer, 'Server Response');
          } else {
            responseContainer.innerHTML = '<h3>Raw JSON Response</h3>'
              + `<pre>${JSON.stringify(json, null, 2)}</pre>`;
          }
        })
        .catch(err => {
          responseContainer.textContent = `Error: ${err.message}`;
        });
      });
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>API Explorer</h1>
    <form id="apiForm" onsubmit="return false;">
      <label>
        Action:
        <select id="action">
          <option value="trades">Upload Trades</option>
          <option value="transfers">Upload Transfers</option>
        </select>
      </label>
      <label>
        BIS / CSCM:
        <select id="limit">
          <option value="8">BIS</option>
          <option value="10" selected>CSCM</option>
        </select>
      </label>
      <label>
        API Key:
        <input type="text" id="apiKey" placeholder="your-api-key-here" required />
      </label>
      <label>
        CSV file:
        <input type="file" id="csvFile" accept=".csv" required />
      </label>
      <div class="buttons">
        <button type="button" id="previewBtn">Preview CSV</button>
        <button type="button" id="sendBtn">Send</button>
      </div>
    </form>

    <div id="previewContainer">No preview yet.</div>
    <div id="responseContainer">No response yet.</div>
  </div>
</body>
</html>
