<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>API Explorer</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
    }
    .container {
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 800px;
      width: 100%;
    }
    h1 {
      margin-bottom: 1rem;
      font-size: 1.75rem;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 1rem;
      align-items: end;
    }
    form label {
      display: flex;
      flex-direction: column;
      font-weight: 500;
    }
    form input, form select {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    form input[type="file"] {
      padding: 0.25rem;
    }
    button {
      grid-column: 1 / -1;
      padding: 0.75rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #responseContainer {
      margin-top: 2rem;
    }
    .response-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .response-table th,
    .response-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .response-table th {
      background-color: #f2f2f2;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('apiForm');
      const responseContainer = document.getElementById('responseContainer');
      const baseUrl = 'https://uk10.haruko.io:2044/cefi/api'; // ← change to your real base URL

      form.addEventListener('submit', e => {
        e.preventDefault();
        const apiKey  = document.getElementById('apiKey').value.trim();
        const file    = document.getElementById('csvFile').files[0];

        responseContainer.textContent = 'Loading…';

        if (file) {
          // CSV upload path
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const text = reader.result;
              const lines = text.split(/\r?\n/).filter(l => l.trim());
              const headers = lines[0].split(/\t|,/).map(h => h.trim());
              const dataLines = lines.slice(1);

              const trades = dataLines.map(line => {
                const cols = line.split(/\t|,/).map(c => c.trim());
                const row = headers.reduce((acc, h, i) => (acc[h] = cols[i], acc), {});
                // parse TIMESTAMP => ms
                const [date, hour, minute, second] = row['TIMESTAMP'].split(':');
                const dt = `${date} ${hour}:${minute}:${second}`;
                const millis = new Date(dt).getTime();

                return {
                  timestamp: millis,
                  venueAccount: row['VENUE ACCOUNT'],
                  venueAccountId: row['VENUE ACCOUNT ID'],
                  venue: row['VENUE'],
                  symbol: row['SYMBOL'],
                  quantity: parseFloat(row['QUANTITY']),
                  price: parseFloat(row['PRICE']),
                  side: row['SIDE'],
                  counterpartyType: row['COUNTERPARTY TYPE'],
                  instrumentType: row['INSTRUMENT TYPE'],
                  additionalDataFields: [
                    { objectIdType: 'PRIMARY_KEY', category: 'Metadata', key: 'ENRICHMENT SOURCE', value: row['ENRICHMENT SOURCE'] },
                    { objectIdType: 'PRIMARY_KEY', category: 'Metadata', key: 'BUNDLE',             value: row['BUNDLE'] },
                    { objectIdType: 'PRIMARY_KEY', category: 'Metadata', key: 'BOOK',               value: row['BOOK'] },
                    { objectIdType: 'PRIMARY_KEY', category: 'Metadata', key: 'PORTFOLIO',          value: row['PORTFOLIO'] },
                    { objectIdType: 'PRIMARY_KEY', category: 'Metadata', key: 'ENTITY',             value: row['ENTITY'] }
                  ]
                };
              });

              const payload = { trades };
              fetch(`${baseUrl}/trades`, {
                method: 'POST',
                headers: {
                  'Authorization': `<${apiKey}>`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
              })
              .then(res => {
                if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
                return res.json();
              })
              .then(displayTable)
              .catch(err => responseContainer.textContent = 'Error: ' + err.message);

            } catch (err) {
              responseContainer.textContent = 'CSV parse error: ' + err.message;
            }
          };
          reader.readAsText(file);

        } else {
          // Regular GET path
          const action = document.getElementById('action').value;
          const venue  = encodeURIComponent(document.getElementById('venueAccountId').value);
          const symbol = encodeURIComponent(document.getElementById('symbol').value);
          const url = `${baseUrl}/${action}?venueAccountId=${venue}&symbol=${symbol}&latest=10`;

          fetch(url, {
            method: 'GET',
            headers: {
              'Authorization': `<${apiKey}>`,
              'Content-Type': 'application/json'
            }
          })
          .then(res => {
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            return res.json();
          })
          .then(data => {
            // if wrapped (e.g. { trades: [...] }) unwrap automatically
            const arr = Array.isArray(data) ? data
                      : Array.isArray(data.trades) ? data.trades
                      : Array.isArray(data.transfers) ? data.transfers
                      : [];
            displayTable(arr);
          })
          .catch(err => responseContainer.textContent = 'Error: ' + err.message);
        }
      });

      function displayTable(data) {
        if (!Array.isArray(data) || data.length === 0) {
          responseContainer.textContent = 'No data to display';
          return;
        }
        const table = document.createElement('table');
        table.className = 'response-table';
        // headers
        const thead = table.createTHead();
        const headRow = thead.insertRow();
        Object.keys(data[0]).forEach(key => {
          const th = document.createElement('th');
          th.textContent = key;
          headRow.appendChild(th);
        });
        // body
        const tbody = table.createTBody();
        data.forEach(item => {
          const row = tbody.insertRow();
          Object.values(item).forEach(v => {
            const cell = row.insertCell();
            cell.textContent = (v !== null && typeof v === 'object')
              ? JSON.stringify(v)
              : v;
          });
        });
        responseContainer.innerHTML = '';
        responseContainer.appendChild(table);
      }
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>API Explorer</h1>
    <form id="apiForm">
      <label>
        Action:
        <select id="action">
          <option value="trades">Get Trades</option>
          <option value="transfers">Get Transfers</option>
        </select>
      </label>
      <label>
        Venue Account ID:
        <input type="text" id="venueAccountId" placeholder="e.g. 1234-ABCD" required />
      </label>
      <label>
        Symbol:
        <input type="text" id="symbol" placeholder="e.g. BTCUSD" required />
      </label>
      <label>
        API Key:
        <input type="text" id="apiKey" placeholder="your-api-key-here" required />
      </label>
      <label>
        Or upload CSV:
        <input type="file" id="csvFile" accept=".csv" />
      </label>
      <button type="submit">Send</button>
    </form>
    <h2>Response</h2>
    <div id="responseContainer">Waiting for your request…</div>
  </div>
</body>
</html>
