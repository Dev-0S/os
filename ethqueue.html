<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ETH Queue Monitor — Dev-0S</title>
<meta name="theme-color" content="#0b0c10" />
<style>
  :root { --bg:#0b0c10; --card:#121319; --muted:#8c98a6; --fg:#e8ecf1; --accent:#5ad6a3; --accent2:#9af0ca; --border:#232632; --radius:16px; --container:1280px; --shadow:0 10px 30px rgba(0,0,0,.35); --sidew:256px; }
  *,*::before,*::after{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{ margin:0; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; line-height:1.55; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; }
  a{ color:inherit; text-decoration:none; }
  .container{ max-width:var(--container); margin:0 auto; padding:0 20px; }

  /* When sidebar is open, shift page content */
  body.nav-open{ margin-left: var(--sidew); }

  /* Glassy sticky top nav */
  .nav{ position:fixed; top:0; left:0; right:0; z-index:10; }
  .nav-inner{ height:64px; display:flex; align-items:center; backdrop-filter:saturate(140%) blur(8px); background:rgba(13,14,20,.55); border-bottom:1px solid rgba(255,255,255,.06); }
  .brand{ font-weight:800; letter-spacing:.2px; }
  .brand .dot{ color:var(--accent); }
  .nav-actions{ margin-left:auto; display:flex; gap:10px; align-items:center; }

  .btn { display:inline-flex; align-items:center; gap:10px; cursor:pointer; user-select:none; background:var(--accent); color:#042318; border:0; border-radius:14px; padding:10px 14px; font-weight:800; transition: transform .15s ease, box-shadow .25s ease, filter .25s ease; }
  .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(90,214,163,.28); filter:brightness(1.05); }
  .btn:disabled{ opacity:.65; cursor:not-allowed; }

  /* Hero */
  .hero{ position:relative; min-height:38vh; display:grid; place-items:center; text-align:center; overflow:hidden; margin-top:64px; }
  .hero::before{ content:""; position:absolute; inset:0; background:url('dagestan1.jpeg') center/cover no-repeat fixed; transform:scale(1.02); filter:saturate(1.08) contrast(1.02); }
  .hero::after{ content:""; position:absolute; inset:0; background: radial-gradient(80% 60% at 50% 30%, rgba(12,13,18,.25), rgba(12,13,18,.85)), linear-gradient(to bottom, rgba(12,13,18,.25), rgba(12,13,18,.9)); }
  .hero-content{ position:relative; z-index:1; padding: 10vh 0; }
  .title{ font-size: clamp(28px, 6vw, 48px); font-weight:900; letter-spacing:.5px; margin:0 0 8px; }
  .subtitle{ color:var(--muted); margin:0 auto; max-width:900px; }

  /* Cards & grids */
  section{ padding: 26px 0 46px; }
  .grid{ display:grid; gap:16px; }
  .grid-3{ grid-template-columns: repeat(3, 1fr); }
  .grid-2{ grid-template-columns: repeat(2, 1fr); }
  .grid-1{ grid-template-columns: 1fr; }

  .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }
  .pad{ padding:18px 20px; }
  h3{ margin:0 0 8px; font-size:18px; }
  .muted{ color:var(--muted); }
  .kv{ display:grid; grid-template-columns: auto 1fr; gap:6px 10px; }
  .kv .k{ color:var(--muted); }
  .kv .v{ text-align:right; font-weight:700; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-variant-numeric: tabular-nums; white-space: nowrap; }

  .note{ font-size:12px; color:var(--muted); margin-top:6px; }

  /* Loader */
  .loader.hidden { display: none; }
  .loader {
    position: fixed; inset: 0; display: grid; place-items: center;
    background: rgba(11,12,16,0.55); backdrop-filter: blur(2px);
    z-index: 9999;
  }
  .spinner { width: 78px; height: 78px; position: relative; margin-bottom: 12px; }
  .spinner::before, .spinner::after {
    content: ""; position: absolute; inset: 0; border-radius: 50%;
    border: 3px solid transparent; border-top-color: var(--accent);
    animation: spin 1s linear infinite;
  }
  .spinner::after { inset: 8px; border-top-color: var(--accent2); animation-duration: 1.6s; }
  .loader p { color: var(--muted); font-size: 12px; letter-spacing: .02em; }
  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 980px){ .grid-3{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 720px){ .grid-2, .grid-3{ grid-template-columns: 1fr; } .hero::before{ background-attachment: scroll; } }

  /* ---------- Sidebar (same style as staking page) ---------- */
  .sidenav {
    position: fixed; inset: 0 auto 0 0; width: var(--sidew);
    background: #0f1016; border-right: 1px solid var(--border);
    padding: 14px; display: flex; flex-direction: column; gap: 10px;
    z-index: 1000; transform: translateX(-100%); transition: transform .25s ease;
  }
  .sidenav header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 6px 6px 12px; }
  .sidenav .brand { font-weight:900; letter-spacing:.3px; color:var(--fg); }
  .sidenav .close{ background:transparent; border:0; color:var(--muted); font-size:20px; cursor:pointer; border-radius:10px; padding:6px; }
  .sidenav .close:hover{ color:var(--fg); background: rgba(255,255,255,.06); }
  .sidenav nav{ display:flex; flex-direction:column; gap:8px; margin-top:6px; }

  .nav-item{
    position:relative; display:flex; align-items:center; gap:12px;
    padding:10px 12px; border-radius:12px; color:var(--muted);
    border:1px solid rgba(255,255,255,.06);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
    transition: background .2s ease, box-shadow .25s ease, color .2s ease, border-color .2s ease;
    font-weight:700; letter-spacing:.2px;
  }
  .nav-item::before{
    content:""; position:absolute; left:0; top:0; bottom:0; width:3px;
    background:transparent; border-radius:12px 0 0 12px; transition:background .2s ease;
  }
  .nav-item:hover{
    color:var(--fg);
    background:linear-gradient(90deg, rgba(90,214,163,.12), rgba(90,214,163,0.02));
    border-color:rgba(90,214,163,.25);
    box-shadow: inset 0 0 0 1px rgba(90,214,163,.08), 0 10px 24px rgba(0,0,0,.25);
  }
  .nav-item:hover::before{ background:var(--accent); }
  .nav-item.active{
    color:var(--fg);
    border-color:rgba(90,214,163,.35);
    background:linear-gradient(90deg, rgba(90,214,163,.16), rgba(90,214,163,0.04));
    box-shadow: inset 0 0 0 1px rgba(90,214,163,.12);
  }
  .nav-item.active::before{ background:var(--accent); }
  .nav-icon{ width:18px; height:18px; flex:0 0 auto; display:inline-block; filter: drop-shadow(0 1px 0 rgba(0,0,0,.35)); }

  /* Toggle button */
  .sidenav-toggle{
    position: fixed; left: 12px; top: 12px;
    z-index: 900; /* below sidebar (1000) so it never sits on top */
    background: var(--accent); color:#042318; border:0; border-radius:12px; padding:10px 12px; font-weight:800; cursor:pointer;
    box-shadow: 0 10px 24px rgba(90,214,163,.25);
    transition: opacity .2s ease, transform .2s ease;
  }
  /* Hide toggle when sidebar open (prevents overlap) */
  body.nav-open .sidenav-toggle{ opacity:0; pointer-events:none; transform: translateX(-8px) scale(0.96); }

  /* Open state */
  .sidenav.open{ transform: translateX(0); }
</style>
</head>
<body class="nav-open"><!-- start open to match the other page -->

<!-- Sidebar -->
<button class="sidenav-toggle" id="sidenavToggle" aria-label="Open menu">☰</button>
<aside class="sidenav" id="sidenav" aria-label="Side navigation">
  <header>
    <div class="brand">Dev-0S</div>
    <button class="close" id="sidenavClose" aria-label="Close">✕</button>
  </header>
  <nav>
    <a href="YOUR-STAKING-OPTIMISER-URL.html" class="nav-item" id="link-optimiser" title="Staking Transfer Optimiser">
      <!-- sliders icon -->
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 7h10M4 17h16M14 7v6M10 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>Staking Transfer Optimiser</span>
    </a>
    <a href="https://dev-0s.github.io/os/ethqueue.html" target="_self" class="nav-item active" id="link-queue" title="ETH Queue Monitor">
      <!-- list icon -->
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 6h16M4 12h12M4 18h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>ETH Queue Monitor</span>
    </a>
  </nav>
</aside>

  <!-- NAV -->
  <nav class="nav">
    <div class="nav-inner">
      <div class="container" style="display:flex; align-items:center; gap:16px;">
        <div class="brand">Dev<span class="dot">-</span>0S</div>
        <div class="nav-actions" style="margin-left:auto;">
          <button id="refresh" class="btn" title="Refresh queue data">⟳ Refresh</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero">
    <div class="hero-content container">
      <h1 class="title">Ethereum Entry / Exit Queue Monitor</h1>
      <p class="subtitle">Live snapshot parsed from validatorqueue.com. We show queue sizes, estimated waits, and exit → withdrawable timing (+256 epochs).</p>
    </div>
  </header>

  <!-- CONTENT -->
  <section>
    <div class="container grid grid-3">
      <div class="card pad">
        <h3>Status</h3>
        <div class="kv">
          <div class="k">Snapshot date</div><div class="v mono" id="snapDate">—</div>
          <div class="k">Active validators</div><div class="v mono" id="active">—</div>
          <div class="k">Churn / epoch</div><div class="v mono" id="churn">—</div>
        </div>
        <div class="note">If the site updates daily, “Snapshot date” reflects their latest data point.</div>
      </div>

      <div class="card pad">
        <h3>Entry Queue</h3>
        <div class="kv">
          <div class="k">Validators waiting</div><div class="v mono" id="entryQ">—</div>
          <div class="k">Estimated wait</div><div class="v mono" id="entryWait">—</div>
          <div class="k">ETA to activation</div><div class="v mono" id="entryEta">—</div>
        </div>
        <div class="note">ETA = now + wait (days). Assumes churn and queue stay roughly stable.</div>
      </div>

      <div class="card pad">
        <h3>Exit Queue</h3>
        <div class="kv">
          <div class="k">Validators waiting</div><div class="v mono" id="exitQ">—</div>
          <div class="k">Estimated wait</div><div class="v mono" id="exitWait">—</div>
          <div class="k">ETA to exit</div><div class="v mono" id="exitEta">—</div>
          <div class="k">Withdrawable (+256 epochs)</div><div class="v mono" id="withdrawEta">—</div>
        </div>
        <div class="note">After exit is processed, funds become withdrawable ~27.3 hours later (256 epochs).</div>
      </div>
    </div>
  </section>

  <!-- LOADER -->
  <div id="loader" class="loader hidden" aria-hidden="true">
    <div class="spinner"></div>
    <p>Fetching validator queue…</p>
  </div>

<script>
(function(){
  "use strict";

  /* Sidebar toggle */
  const sidenav = document.getElementById('sidenav');
  const toggleBtn = document.getElementById('sidenavToggle');
  const closeBtn  = document.getElementById('sidenavClose');
  function openNav(){ document.body.classList.add('nav-open'); sidenav.classList.add('open'); }
  function closeNav(){ sidenav.classList.remove('open'); document.body.classList.remove('nav-open'); }
  function toggleNav(){ if (document.body.classList.contains('nav-open')) closeNav(); else openNav(); }
  // start open (to match your other page)
  openNav();
  toggleBtn.addEventListener('click', toggleNav);
  closeBtn.addEventListener('click', closeNav);
  sidenav.querySelectorAll('a').forEach(a => a.addEventListener('click', closeNav));
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeNav(); });

  /* Existing queue code */
  const ENDPOINTS = [
    "https://www.validatorqueue.com/",
    "https://validatorqueue.com/",
    "https://r.jina.ai/http://www.validatorqueue.com/",
    "https://r.jina.ai/http://validatorqueue.com/"
  ];

  const EPOCH_SEC = 32 * 12;              // 6.4 minutes
  const WITHDRAW_DELAY_EPOCHS = 256;      // ~27.3067 hours

  const $ = (id) => document.getElementById(id);
  const fmtInt = (n)=> (n==null? "—" : Number(n).toLocaleString());
  const fmtDays = (d)=> (d==null? "—" : `${d.toFixed(2)} days`);
  const fmtDT = (ms)=> isFinite(ms) ? new Date(ms).toLocaleString() : "—";

  const loader = $("loader");
  function showLoader(){ loader.classList.remove("hidden"); loader.setAttribute("aria-hidden","false"); }
  function hideLoader(){ loader.classList.add("hidden"); loader.setAttribute("aria-hidden","true"); }

  async function fetchFirstOkay(urls){
    let lastErr;
    for (const url of urls){
      try{
        const res = await fetch(url, {mode:"cors"});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        if (!text || text.length < 1000) throw new Error("Empty/short response");
        return {url, text};
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("All endpoints failed");
  }

  function extractHistoricalData(htmlText){
    const m = htmlText.match(/historical_data\s*=\s*(\[[\s\S]*?\]);/);
    if (!m) throw new Error("Could not locate historical_data in the page");
    let jsonText = m[1];
    jsonText = jsonText.replace(/,\s*([}\]])/g, "$1");
    try{
      const arr = JSON.parse(jsonText);
      if (!Array.isArray(arr) || !arr.length) throw new Error("historical_data not an array");
      return arr;
    }catch(e){
      const repaired = jsonText.replace(/&quot;/g, '"').replace(/&amp;/g, '&');
      const arr = JSON.parse(repaired);
      if (!Array.isArray(arr) || !arr.length) throw new Error("historical_data parse error");
      return arr;
    }
  }

  function renderFromRow(row){
    const now = Date.now();
    const entryEta = (row.entry_wait!=null) ? now + row.entry_wait*24*3600*1000 : NaN;
    const exitEta  = (row.exit_wait!=null)  ? now + row.exit_wait*24*3600*1000  : NaN;
    const withdrawEta = isFinite(exitEta) ? exitEta + WITHDRAW_DELAY_EPOCHS * EPOCH_SEC * 1000 : NaN;

    $("snapDate").textContent = row.date || "—";
    $("active").textContent   = fmtInt(row.validators);
    $("churn").textContent    = row.churn != null ? `${row.churn} / epoch` : "—";

    $("entryQ").textContent   = fmtInt(row.entry_queue);
    $("entryWait").textContent= row.entry_wait!=null ? fmtDays(Number(row.entry_wait)) : "—";
    $("entryEta").textContent = fmtDT(entryEta);

    $("exitQ").textContent    = fmtInt(row.exit_queue);
    $("exitWait").textContent = row.exit_wait!=null ? fmtDays(Number(row.exit_wait)) : "—";
    $("exitEta").textContent  = fmtDT(exitEta);
    $("withdrawEta").textContent = fmtDT(withdrawEta);
  }

  async function refresh(){
    $("refresh").disabled = true;
    showLoader();
    try{
      const {text} = await fetchFirstOkay(ENDPOINTS);
      const hist = extractHistoricalData(text);
      const latest = hist.reduce((a,b)=> (new Date(a.date) > new Date(b.date) ? a : b));
      renderFromRow(latest);
    }catch(e){
      console.error(e);
      const msg = e && e.message ? e.message : String(e);
      alert("Failed to fetch queue data.\n\n" + msg + "\n\nIf this is a CORS issue, the fallback reader may be blocked. We can switch to a tiny proxy later.");
    }finally{
      setTimeout(()=>{ hideLoader(); $("refresh").disabled = false; }, 500);
    }
  }

  $("refresh").addEventListener("click", refresh);
  refresh();
})();
</script>
</body>
</html>
